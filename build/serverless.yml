--- 
frameworkVersion: ">=1.28.0 <2.0.0"
functions: 
  error:
    handler: cmd/errors
    onError: !GetAtt ErrorQueue.Arn
    name: errorHandler-${self:provider.stage}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - sqs:SendMessage
          - sqs:ReceiveMessage
          - sqs:DeleteMessage
          - sqs:GetQueueAttributes
        Resource: 
          - !GetAtt ErrorQueue.Arn
    events:
      - sqs:
          arn: !GetAtt ErrorQueue.Arn      
  prospectbot:
    handler: cmd/prospectbot
    onError: !GetAtt ErrorQueue.Arn
    name: prospectbot-${self:provider.stage}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:ListTables
          - dynamodb:GetItem
          - dynamodb:Query
          - dynamodb:UpdateItem
          - dynamodb:Scan
        Resource: "*"
      - Effect: Allow
        Action:
          - sqs:SendMessage
        Resource:
          - !GetAtt ErrorQueue.Arn
    events:
      - schedule:
          rate: rate(10 minutes)
          enabled: true
          name: run-prospectbot-${opt:stage, 'dev'}
          description: Checks Github for new software releases
package:
 exclude:
   - ../**
 include:
   - ../cmd/*
   - ../internal/*
provider: 
  deploymentBucket: 
    name: serverless-deployment-stacks
    serverSideEncryption: AES256
  deploymentPrefix: prospectbot
  memorySize: 512
  name: aws
  region: ${opt:region, 'us-east-1'}
  runtime: go1.x
  stage: ${opt:stage, 'dev'}
  timeout: 60
  versionFunctions: false
  vpc: 
    securityGroupIds: 
      - sg-0a004076bb0b36504
    subnetIds: 
      - subnet-0fd39854
      - subnet-c436a7a1
      - subnet-d61aa3da
service: prospectbot
plugins:
  - serverless-iam-roles-per-function
resources:
  Resources:
    ErrorQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: prospectbot-errors-${opt:stage, 'dev'}
        VisibilityTimeout: 900
