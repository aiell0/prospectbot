--- 
frameworkVersion: ">=1.28.0 <2.0.0"
functions: 
  prospectbot:
    handler: cmd/main
    onError: !Ref DLQ
    name: prospectbot-${self:provider.stage}
    events:
      - schedule:
          rate: rate(10 minutes)
          enabled: true
          name: run-prospectbot-${opt:stage, 'dev'}
          description: 'Checks Github for new software releases'
package:
 exclude:
   - ../**
 include:
   - ../cmd/*
   - ../internal/*
provider: 
  deploymentBucket: 
    name: serverless-deployment-stacks
    serverSideEncryption: AES256
  deploymentPrefix: prospectbot
  memorySize: 512
  name: aws
  region: ${opt:region, 'us-east-1'}
  runtime: go1.x
  stage: ${opt:stage, 'dev'}
  timeout: 60
  versionFunctions: false
  vpc: 
    securityGroupIds: 
      - sg-0a004076bb0b36504
    subnetIds: 
      - subnet-0fd39854
      - subnet-c436a7a1
      - subnet-d61aa3da
  iamRoleStatements:
      - Effect: "Allow"
        Action:
          - "dynamodb:PutItem"
          - "dynamodb:ListTables"
          - "dynamodb:GetItem"
          - "dynamodb:Query"
          - "dynamodb:UpdateItem"
          - "dynamodb:Scan"
        Resource: "*"
      - Effect: "Allow"
        Action:
          - "sns:Publish"
        Resource: arn:aws:sns:${opt:region, 'us-east-1'}:385445628596:prospectbot-${opt:stage, 'dev'}-dlq
service: prospectbot
resources:
  Resources:
    DLQ:
      Type: AWS::SNS::Topic
      Properties:
        DisplayName: prospectbot-${opt:stage, 'dev'}-dlq
        KmsMasterKeyId: d47201dc-0660-4c8d-80de-58ec583bc48b
        TopicName: prospectbot-${opt:stage, 'dev'}-dlq
    EmailSubscription:
      Type: AWS::SNS::Subscription
      Properties:
        Endpoint: lawrence.aiello@laiello.com
        Protocol: email
        TopicArn: !Ref DLQ
    SMSSubscription:
      Type: AWS::SNS::Subscription
      Properties:
        Endpoint: 2028536141
        Protocol: sms
        TopicArn: !Ref DLQ

