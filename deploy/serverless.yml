--- 
frameworkVersion: ">=1.28.0 <2.0.0"
custom:
  SLACK_CHANNEL:
    environment:
      test: CPEN4FNM6
      dev: CPEN4FNM6
      qa: CPEN4N648
      prod: CPGHX0V2T
  slacktoken: ${ssm:/slack/access-token)
functions: 
  pick:
    handler: cmd/pick
    onError: !GetAtt ErrorQueue.Arn
    name: pick-${self:provider.stage}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - sqs:SendMessage
        Resource:
          - !GetAtt ErrorQueue.Arn
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:Scan
          - dynamodb:Query
        Resource:
          - arn:aws:dynamodb:us-east-1:385445628596:table/miners-dev
  error:
    handler: cmd/errors
    onError: !GetAtt ErrorQueue.Arn
    name: errorHandler-${self:provider.stage}
    environment:
      SLACK_CHANNEL: CPUF4Q8LT
      SLACK_TOKEN: ${self:custom.slacktoken}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - kms:Decrypt
        Resource:
          - arn:aws:kms:us-east-1:385445628596:key/d47201dc-0660-4c8d-80de-58ec583bc48b
      - Effect: Allow
        Action:
          - sqs:SendMessage
          - sqs:ReceiveMessage
          - sqs:DeleteMessage
          - sqs:GetQueueAttributes
        Resource: 
          - !GetAtt ErrorQueue.Arn
    events:
      - sqs:
          arn: !GetAtt ErrorQueue.Arn      
  prospectbot:
    handler: cmd/prospectbot
    onError: !GetAtt ErrorQueue.Arn
    name: prospectbot-${self:provider.stage}
    environment:
      SLACK_CHANNEL: ${self:custom.SLACK_CHANNEL.environment.${self:provider.stage}}
      SLACK_TOKEN: ${self:custom.slacktoken}
      SYSTEM_TABLE: prospectbot-${self:provider.stage}
      MINER_TABLE: miners-${self:provider.stage}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - kms:Decrypt
        Resource:
          - "arn:aws:kms:us-east-1:385445628596:key/d47201dc-0660-4c8d-80de-58ec583bc48b"
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:ListTables
          - dynamodb:GetItem
          - dynamodb:Query
          - dynamodb:UpdateItem
          - dynamodb:Scan
        Resource: "*"
      - Effect: Allow
        Action:
          - sqs:SendMessage
        Resource:
          - !GetAtt ErrorQueue.Arn
    events:
      - https:
          path: prospectbot/
          method: post
          integration: lambda
          requests:
            passThrough: NEVER
      - schedule:
          rate: rate(10 minutes)
          enabled: true
          name: run-prospectbot-${opt:stage, 'dev'}
          description: Checks Github for new software releases
package:
 exclude:
   - ../**
 include:
   - ../cmd/*
   - ../internal/*
provider: 
  deploymentBucket: 
    name: serverless-deployment-stacks
    serverSideEncryption: AES256
  deploymentPrefix: prospectbot
  memorySize: 512
  name: aws
  region: ${opt:region, 'us-east-1'}
  runtime: go1.x
  stage: ${opt:stage, 'dev'}
  timeout: 60
  versionFunctions: false
  vpc: 
    securityGroupIds: 
      - sg-0a004076bb0b36504
    subnetIds: 
      - subnet-0fd39854
      - subnet-c436a7a1
      - subnet-d61aa3da
service: prospectbot
plugins:
  - serverless-iam-roles-per-function
resources:
  Resources:
    APIRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal:
                Service:
                  - apigateway.amazonaws.com
              Action:
                - 'sts:AssumeRole'
        Path: /
        Policies:
          - PolicyName: find
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - lambda:InvokeFunction
                  Resource: 
                    - Fn::Join:
                      - ':'
                      -
                        - arn:aws:lambda
                        - Ref: AWS::Region
                        - Ref: AWS::AccountId
                        - function
                        - pick-${opt:stage, 'dev'}
    PostMethod:
      Type: AWS::ApiGateway::Method
      Properties:
        AuthorizationType: AWS_IAM
        HttpMethod: POST
        RestApiId: !Ref API
        ResourceId: !GetAtt API.RootResourceId
        Integration:
          Credentials: !GetAtt APIRole.Arn
          IntegrationHttpMethod: POST
          PassthroughBehavior: WHEN_NO_TEMPLATES
          Type: AWS
          Uri: 
            Fn::Join:
              - ':'
              -
                - arn:aws:apigateway
                - Ref: AWS::Region
                - lambda:path/2015-03-31/functions/arn:aws:lambda
                - Ref: AWS::Region
                - Ref: AWS::AccountId
                - function
                - pick-${opt:stage, 'dev'}/invocations
    APIDeployment:
      Type: AWS::ApiGateway::Deployment
      DependsOn: PostMethod
      Properties:
        Description: The Slack slash command "/find"
        RestApiId: !Ref API
        StageName: ${opt:stage, 'dev'}
    BasePathMapping:
      Type: AWS::ApiGateway::BasePathMapping
      Properties:
        BasePath: prospectbot
        DomainName: !Ref Domain
        RestApiId: !Ref API
    API:
      Type: AWS::ApiGateway::RestApi
      Properties: 
        Name: Prospectbot
        Description: API for Prospectbot Slack slash commands.
        FailOnWarnings: False
        EndpointConfiguration:
          Types:
            - REGIONAL
    RecordSet:
      Type: AWS::Route53::RecordSet
      Properties:
        Type: CNAME
        TTL: 60
        Name: www.blockforgecapital.com
        HostedZoneId: Z2HEWVOTSTGMIM
        ResourceRecords:
          - !GetAtt Domain.DistributionDomainName
    Domain:
      Type: AWS::ApiGateway::DomainName
      Properties:
        DomainName: www.blockforgecapital.com
        CertificateArn:	arn:aws:acm:us-east-1:385445628596:certificate/8e169b97-ca9b-4578-9c5c-476f59b75c92
        EndpointConfiguration:
          Types:
            - EDGE
        SecurityPolicy: TLS_1_2
    ErrorQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: prospectbot-errors-${opt:stage, 'dev'}
        VisibilityTimeout: 900
